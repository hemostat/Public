---
title: "GxA results version 4-long"
author: "Andrey Ziyatdinov"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: united
    toc: true
    number_sections: true
    keep_md: true
    includes:
      in_header: header.html
  pdf_document:
    toc: true
    toc_depth: 3
    number_sections: true    
---

```{r options, echo = F}
opts_chunk$set(dev = "png", dev.args = list(type = "cairo"), dpi = 192/1.5,
  fig.path = "figures/", comment = NA, results = 'markup', tidy = F, message = F, warning = F, echo = F, cache = T)
```


```{r inc, cache = FALSE}
library(devtools)
load_all("~/git/hemostat/copdgene")

load_all("~/git/variani/qq")
load_all("~/git/variani/matlm")
load_all("~/git/variani/wlm")

library(dplyr)
library(broom)

library(pander)

library(tidyverse)

library(dplyr)
library(plyr)

library(ggplot2)
library(gridExtra)
library(RColorBrewer)
library(cowplot)
```


```{r settings, cache = FALSE}
theme_set(theme_light())

panderOptions('table.style', 'rmarkdown')

panderOptions('table.split.table', Inf)
panderOptions('knitr.auto.asis', FALSE)
```

```{r settings_copdgene, cache = FALSE}
options(copdgene_ver_acs = 2)
```

```{r traits}
traits_cont <- copdgene_traits_main()[-1]
traits_bin <- copdgene_traits_main()[1]
traits_all <- c(traits_bin, traits_cont)
```

```{r tab1}
path_results <- copdgene_path_results(dir = "05-ver-4-long")

tab1 <- copdgene_results_admixed(traits_cont, "SmokCigNow", path_results)
tab2 <- copdgene_results_admixed(traits_cont, "SmokCigNow0_15", path_results)

```{r massoc}
massoc1 <- readRDS(file.path(path_results, "massoc.interaction.SmokCigNow.rds"))
massoc2 <- readRDS(file.path(path_results, "massoc.interaction.SmokCigNow0_15.rds"))
```

# QQ plots


## Interaction with SmokCigNow 

```{r qq1}
plots1 <- llply(traits_cont, function(t) {
  assoc <- filter(tab1, trait == t)
  
  qq_plot(assoc$pval, size = 0.5, linetype = 2) + 
    labs(title = paste(t, sep = "*"),
      x = "", y = "SmokCigNow") 
})
```

```{r fig_qq1, fig.width = 9, fig.height = 9, dependson = -1}
do.call(grid.arrange, c(plots1, nrow = 3)) 
```

## Interaction with SmokCigNow0_15 

```{r qq2}
plots2 <- llply(traits_cont, function(t) {
  assoc <- filter(tab2, trait == t)
  
  qq_plot(assoc$pval, size = 0.5, linetype = 2) + 
    labs(title = paste(t, sep = "*"),
      x = "", y = "SmokCigNow0_15") 
})
```

```{r fig_qq2, fig.width = 9, fig.height = 9, dependson = -1}
do.call(grid.arrange, c(plots2, nrow = 3)) 
```

# Quality control on multi-trait analysis

- `r length(traits_cont)` traits: `r paste(traits_cont, collapse = ", ")`
- threshold: 3

## Interaction with SmokCigNow 

```{r sigma1, fig.width = 6, fig.height = 6}
dat <- arrange(tab1, trait, chr, acs)
  
Z <- lapply(traits_cont, function(tr) with(dat, zscore[trait == tr])) %>%
  do.call(cbind, .) %>%
  as.matrix(Z)
colnames(Z) <- traits_cont
    
Sigma <- copdgene_compute_covz(Z, "tmvn", thr = 3)

plot_cov(Sigma) 
```

```{r massoc_qq1, fig.width = 4, fig.height = 4}
qq_plot(massoc1$pval)
```

## Interaction with SmokCigNow0_15 


```{r sigma2, fig.width = 6, fig.height = 6}
dat <- arrange(tab2, trait, chr, acs)
  
Z <- lapply(traits_cont, function(tr) with(dat, zscore[trait == tr])) %>%
  do.call(cbind, .) %>%
  as.matrix(Z)
colnames(Z) <- traits_cont
    
Sigma <- copdgene_compute_covz(Z, "tmvn", thr = 3)

plot_cov(Sigma) 
```
  
  
```{r massoc_qq2, fig.width = 4, fig.height = 4}
qq_plot(massoc2$pval)
```

